<!DOCTYPE html> 
<html>
    <head>
        <script src="lib/sockjs-0.3.min.js"></script>
        <script src="lib/jaws.js"></script>
        <script>
            //some global variables
            var you = new jaws.SpriteList();
            var players = new jaws.SpriteList();
            // This maps the player id to it's sprites locations
            var players_map = {};
            var bullets = new jaws.SpriteList();
            var bulletids = [];
            
            var sock;

            var you_bottom;
            var you_top;
            //--------------------------
            //Helper Fuctions
            //--------------------------
            function addPlayer(x, y, pid) {
                //Helper function to add a player
                var b = new jaws.Sprite({'image':"images/tankbot.png", x:x, y:y,'anchor':"center"});
                b.pid = pid;
                b.velocity = [0, 0];

                var t = new jaws.Sprite({'image':"images/tanktop.png", x:x, y:y,'anchor_x':0.5, 'anchor_y':0.75});
                t.pid = pid;
                players.push(b);
                players.push(t);
            }

            function addBullet(id, x, y, rot) {
                // Helper function to add a bullet
                var b = new jaws.Sprite({'image':'images/bluebullet.png', x:x, y:y,'anchor':'center'});
                b.angle = rot;
                b.id = id;
                bullets.push(b);
                bulletids.push(id);
            }
            function isOutsideCanvas(item) { 
                // check to see if item is outside the canvas
                return (item.x < 0 || item.y < 0 || item.x > jaws.width || item.y > jaws.height) 
            }

            //-------------------------
            // INITIAL GAME STATE
            //------------------------
            function connectSocketsState() {
                this.setup = function() {
                    //-----------
                    // Sockets
                    //-----------
                    sock = new SockJS('http://localhost:8090');
                    sock.onopen = function() {
                        console.log('open');
                        var timestamp = (new Date).getTime();
                        sock.send(JSON.stringify({"timestamp":timestamp}));
                    }

                    sock.onmessage = function(e) {
                        var current_ts = (new Date).getTime();
                        // This function is only until the servers has recognized your connection
                        var d = JSON.parse(e.data)
                        if (d['server_timestamp']) {
                            var server_ts = d['server_timestamp'];
                            var client_ts = d['client_timestamp'];

                            var ping = current_ts - client_ts;
                            var current_server = (server_ts - current_ts + ping / 2) + current_ts;
                            console.log(ping);
                            console.log(current_ts);
                            console.log(client_ts);
                            console.log(server_ts);
                            console.log(current_server);
                        }
                        if (d['new_you']) {
                            // This should always be you
                            var p = JSON.parse(d['new_you']);
                            var x = p['x'];
                            var y = p['y'];

                            you_bottom = new jaws.Sprite({'image':"images/tankbot.png", x:x, y:y,'anchor':"center"});
                            you_bottom.velocity = [0, 0];

                            you_top = new jaws.Sprite({'image':"images/tanktop.png", x:x, y:y,'anchor_x':0.5, 'anchor_y':0.75});
                            you.push(you_bottom);
                            you.push(you_top);

                            // Switch the game state. This changes sock.onemessage 
                            //jaws.switchGameState(PlayState);    
                        }
                        
                        if (d['player_list']) {
                            // Add any existing players to the map
                            var player_list = d['player_list'];
                            for (i in player_list) {
                                if (parseInt(i)) {
                                    var sp = player_list[i];
                                    addPlayer(sp['x'], sp['y'], sp['pid']);
                                }
                            }
                        }
                    }

                    sock.onclose = function() {
                        console.log('closed');
                    }

                }

                this.draw = function() {
                    jaws.context.clearRect(0,0,jaws.width,jaws.height)
                    jaws.context.font = "bold 50pt terminal";
                    jaws.context.lineWidth = 10
                    jaws.context.fillStyle = "Black"
                    jaws.context.fillText("Connecting to server", 30, 100)
                }
            }
            function PlayState() {
                this.setup = function() {
                    jaws.preventDefaultKeys(["space", "w", "a", "s", "d", "left", "right"]);

                    sock.onmessage = function(e) {
                        var d = JSON.parse(e.data)
                        if (d['new_player']) {
                            var p = JSON.parse(d['new_player']);
                            var x = p['x'];
                            var y = p['y'];
                            var id = p['pid'];
                            addPlayer(x, y, id);
                        } 
                        
                        if (d['player_list']) {
                            var player_list = d['player_list'];
                            function updatePlayers(ip, index) {
                                //server player
                                var sp = player_list[ip.pid];
                                ip.moveTo(sp['x'], sp['y']);
                                if (ip.image_path == 'images/tanktop.png') {
                                    ip.angle = sp['trot'];
                                } else {
                                    ip.angle = sp['rot'];
                                }
                            }
                            players.forEach(updatePlayers);
                        }

                        if (d['new_bullets'] && d['new_bullets'].length != 0) {
                            // Handle when a new bullet needs to be drawn
                            var new_bullets = d['new_bullets'];

                            function processNewBullet(b) {
                                addBullet(b['id'], b['x'], b['y'], b['rot']);
                            }
                            new_bullets.forEach(processNewBullet);
                        }

                        if (d['bullet_list']) {
                            var bl = d['bullet_list'];

                            function processBullet(b) {
                                bullets.forEach(function(bull) {
                                    if (bull['id'] == b['id']) {
                                        bull.moveTo(b['x'], b['y']);
                                    }
                                });
                            }
                            
                            bl.forEach(processBullet);
                        }
                    }
                    
                    bullets.removeIf(isOutsideCanvas)
                //END OF SETUP
                }

                this.update = function() {

                    // a list of all the keys pressed we care about on this rendering
                    var actions = [];

                    if(jaws.pressed("space")) {
                        actions.push('fire');
                    }

                    if(jaws.pressed("w")) { 
                        actions.push('w');
                        var a = [0,0];

                        var r = you_bottom.angle + 90;

                        a[0] += Math.cos(r*(Math.PI/180))*.9
                        a[1] += Math.sin(r*(Math.PI/180))*.9

                        var ff = .5
                        
                        you_bottom.velocity[0] *= ff;
                        you_bottom.velocity[1] *= ff;

                        you_bottom.velocity[0] += a[0]; 
                        you_bottom.velocity[1] += a[1];

                        you_bottom.x -= you_bottom.velocity[0];
                        you_bottom.y -= you_bottom.velocity[1];
                        
                        you_top.x -= you_bottom.velocity[0];
                        you_top.y -= you_bottom.velocity[1];
                    }
                    if(jaws.pressed("s")) {
                        actions.push('s');
                        var a = [0,0];

                        var r = you_bottom.angle + 90;

                        a[0] += Math.cos(r*(Math.PI/180))*.9
                        a[1] += Math.sin(r*(Math.PI/180))*.9

                        var ff = .5
                        
                        you_bottom.velocity[0] *= ff;
                        you_bottom.velocity[1] *= ff;

                        you_bottom.velocity[0] += a[0]; 
                        you_bottom.velocity[1] += a[1];

                        you_bottom.x += you_bottom.velocity[0];
                        you_bottom.y += you_bottom.velocity[1];
                        
                        you_top.x += you_bottom.velocity[0];
                        you_top.y += you_bottom.velocity[1];
                    
                    }
                    if(jaws.pressed("a")) { 
                        actions.push('a');
                        you_bottom.angle -= 1;
                    }
                    if(jaws.pressed("d")) {
                        actions.push('d');
                        you_bottom.angle += 1;
                    }

                    if(jaws.pressed("left")) {
                        actions.push('left');
                        you_top.angle -= 1;
                    }
                    
                    if(jaws.pressed("right")) {
                        actions.push('right');
                        you_top.angle += 1;
                    }

                   
                    // If they have pressed any keys we care about, send a message to the server
                    if (actions.length != 0) {
                        var timestamp = (new Date).getTime();
                        sock.send(JSON.stringify({"ts":timestamp,"actions":actions}));
                    }
                }
                this.draw = function() {
                    jaws.context.clearRect(0,0,jaws.width,jaws.height);
                    you.draw();
                    players.draw();
                    bullets.draw();
                }
            }
            
            // WINDOW LOADED
            window.onload = function() {
                jaws.assets.add("images/tanktop.png");
                jaws.assets.add("images/tankbot.png");
                jaws.assets.add("images/bluebullet.png");
                jaws.start(connectSocketsState, {fps:30});
            }

        </script>
    </head>
    <body>
        <canvas id="game" width="500" height="500"></canvas>
    </body>
</html>
