<!DOCTYPE html> 
<html>
    <head>
        <script src="http://cdn.sockjs.org/sockjs-0.3.min.js"></script>
        <script src="lib/jaws.js"></script>
        <script>
            var sock;

            var players = new jaws.SpriteList();

            function connectSocketsState() {
                this.setup = function() {
                    //-----------
                    // Sockets
                    //-----------
                    sock = new SockJS('http://localhost:8090');
                    sock.onopen = function() {
                        console.log('open');
                        jaws.switchGameState(PlayState);    
                    }

                    sock.onmessage = function(e) {
                        var d = JSON.parse(e.data)
                        if (d['newplayer']) {
                            console.log('new player');
                            var x = d['newplayer']['x'];
                            var y = d['newplayer']['y'];
                            var b = new jaws.Sprite({'image':"images/tankbot.png", x:x, y:y,'anchor':"center"});
                            var t = new jaws.Sprite({'image':"images/tanktop.png", x:x, y:y,'anchor_x':0.5, 'anchor_y':0.75});
                            console.log(b);
                            players.push(b);
                            players.push(t);
                        }
                    }

                    sock.onclose = function() {
                        console.log('closed');
                    }

                }

                this.draw = function() {
                    jaws.context.clearRect(0,0,jaws.width,jaws.height)
                    jaws.context.font = "bold 50pt terminal";
                    jaws.context.lineWidth = 10
                    jaws.context.fillStyle = "Black"
                    jaws.context.fillText("Connecting", 30, 100)
                }
            }
            function PlayState() {
                var bottom;
                var ttop;

                this.setup = function() {
                    bottom = new jaws.Sprite({'image':"images/tankbot.png", x:100, y:100,'anchor':"center"});
                    bottom.velocity = [0, 0];

                    ttop = new jaws.Sprite({'image':"images/tanktop.png", x:100, y:100, 'anchor_x':0.5, 'anchor_y':0.75});
                    
                    jaws.preventDefaultKeys(["w", "a", "s", "d"]);
                }

                this.update = function() {
                    if(jaws.pressed("w")) { 
                        var dx, dy = 1;
                        var a = [0,0];

                        var r = bottom.angle + 90;

                        a[0] += Math.cos(r*(Math.PI/180))*.9
                        a[1] += Math.sin(r*(Math.PI/180))*.9

                        var ff = .5
                        
                        bottom.velocity[0] *= ff;
                        bottom.velocity[1] *= ff;

                        bottom.velocity[0] += a[0]; 
                        bottom.velocity[1] += a[1];

                        bottom.x -= bottom.velocity[0];
                        bottom.y -= bottom.velocity[1];
                        
                        ttop.x -= bottom.velocity[0];
                        ttop.y -= bottom.velocity[1];
                    }
                    if(jaws.pressed("s")) {
                        var dx, dy = 1;
                        var a = [0,0];

                        var r = bottom.angle + 90;

                        a[0] += Math.cos(r*(Math.PI/180))*.9
                        a[1] += Math.sin(r*(Math.PI/180))*.9

                        var ff = .5
                        
                        bottom.velocity[0] *= ff;
                        bottom.velocity[1] *= ff;

                        bottom.velocity[0] += a[0]; 
                        bottom.velocity[1] += a[1];

                        bottom.x += bottom.velocity[0];
                        bottom.y += bottom.velocity[1];
                        
                        ttop.x += bottom.velocity[0];
                        ttop.y += bottom.velocity[1];
                    
                    }
                    if(jaws.pressed("a")) { 
                        bottom.angle -= 1;
                    }
                    if(jaws.pressed("d")) {
                        bottom.angle += 1;
                    }

                    if(jaws.pressed("left")) {
                        ttop.angle -= 1;
                    }
                    
                    if(jaws.pressed("right")) {
                        ttop.angle += 1;
                    }
                }
                this.draw = function() {
                    var me = [bottom.toJSON(), ttop.toJSON()];
                    sock.send(me);

                    jaws.context.clearRect(0,0,jaws.width,jaws.height);
                    players.draw();
                    bottom.draw();
                    ttop.draw();

                }
            }
            window.onload = function() {
                jaws.assets.add("images/tanktop.png");
                jaws.assets.add("images/tankbot.png");
                jaws.assets.add("images/bluebullet.png");
                jaws.start(connectSocketsState, {fps:60});
            }

            function setupSockets() {
            }
        </script>
    </head>
    <body>
        <canvas id="game" width="500" height="500"></canvas>
    </body>
</html>
